require('dotenv').config();
const axios = require('axios');
const express = require('express');
const sqlite3 = require('sqlite3').verbose();
const path = require('path');
const fs = require('fs');

const app = express();
app.use(express.static(path.join(__dirname, 'public')));
const port = process.env.PORT || 3000;

const dbPath = path.resolve(__dirname, 'whatsapp_messages.db');
console.log('üìÇ Adatb√°zis f√°jl helye:', dbPath);

const db = new sqlite3.Database(dbPath);

db.serialize(() => {
  db.run(`
    CREATE TABLE IF NOT EXISTS contacts (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      wa_id TEXT UNIQUE,
      name TEXT
    )
  `);

  db.run(`
    CREATE TABLE IF NOT EXISTS messages (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      contact_id INTEGER,
      message_body TEXT,
      message_type TEXT,
      received_at DATETIME DEFAULT CURRENT_TIMESTAMP,
      wa_message_id TEXT UNIQUE,
      FOREIGN KEY(contact_id) REFERENCES contacts(id)
    )
  `);

  db.run(`
    CREATE TABLE IF NOT EXISTS message_metadata (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      message_id INTEGER,
      status TEXT,
      timestamp TEXT,
      error_code INTEGER,
      error_message TEXT,
      FOREIGN KEY(message_id) REFERENCES messages(id)
    )
  `);

  console.log('‚úÖ Adatb√°zis t√°bl√°k k√©szen √°llnak');
});

app.use(express.json());

// Webhook verifik√°ci√≥
app.get('/webhook', (req, res) => {
  const VERIFY_TOKEN = process.env.VERIFY_TOKEN || 'webhooktoken';
  const mode = req.query['hub.mode'];
  const token = req.query['hub.verify_token'];
  const challenge = req.query['hub.challenge'];

  if (mode && token === VERIFY_TOKEN) {
    console.log('üîê Webhook verifik√°lva!');
    res.status(200).send(challenge);
  } else {
    console.log('‚ùå Webhook verifik√°ci√≥ sikertelen');
    res.sendStatus(403);
  }
});

app.post('/send-message', async (req, res) => {
  const { phone, message } = req.body;
  const phoneNumberId = process.env.PHONE_NUMBER_ID;
  const accessToken = process.env.ACCESS_TOKEN;

  console.log('üö© Access Token:', process.env.ACCESS_TOKEN);
  console.log('üö© All env vars:', process.env);

  console.log('Access token:', accessToken);  // <--- Itt a log

  if (!phone || !message) {
    return res.status(400).json({ message: 'Hi√°nyz√≥ adat (telefonsz√°m vagy √ºzenet)' });
  }

  try {
    const response = await axios.post(
      `https://graph.facebook.com/v19.0/${phoneNumberId}/messages`,
      {
        messaging_product: 'whatsapp',
        to: phone,
        type: 'text',
        text: {
          preview_url: false,
          body: message
        },
      },
      {
        headers: {
          Authorization: `Bearer ${accessToken}`,
          'Content-Type': 'application/json',
        },
      }
    );
    console.log('‚úÖ √úzenet elk√ºldve:', response.data);
    res.json({ message: '√úzenet sikeresen elk√ºldve ‚úÖ' });
  } catch (error) {
    console.error('‚ùå Hiba az √ºzenetk√ºld√©s sor√°n:', error.response?.data || error.message);
    res.status(500).json({ message: 'Hiba az √ºzenetk√ºld√©s sor√°n' });
  }
});

app.post('/send-template-message', async (req, res) => {
  const { phone, template, parameters } = req.body;
  const phoneNumberId = process.env.PHONE_NUMBER_ID;
  const accessToken = process.env.ACCESS_TOKEN;

  if (!phone || !template || !Array.isArray(parameters)) {
    return res.status(400).json({ message: 'Hi√°nyz√≥ adat (telefon, sablon, param√©terek)' });
  }

  try {
    const response = await axios.post(
      `https://graph.facebook.com/v19.0/${phoneNumberId}/messages`,
      {
        messaging_product: 'whatsapp',
        to: phone,
        type: 'template',
        template: {
          name: template,
          language: { code: 'hu' },
          components: [
            {
              type: 'body',
              parameters: parameters.map(p => ({
                type: 'text',
                text: p
              }))
            }
          ]
        }
      },
      {
        headers: {
          Authorization: `Bearer ${accessToken}`,
          'Content-Type': 'application/json',
        }
      }
    );

    console.log('‚úÖ Sablon elk√ºldve:', response.data);
    res.json({ message: 'Sablon sikeresen elk√ºldve ‚úÖ' });
  } catch (error) {
    console.error('‚ùå Hiba a sablonk√ºld√©s sor√°n:', error.response?.data || error.message);
    res.status(500).json({ message: 'Hiba t√∂rt√©nt a sablon k√ºld√©sekor ‚ùå' });
  }
});

// Webhook POST - √ºzenet √©s kontakt ment√©se
app.post('/webhook', (req, res) => {
  console.log("üì® Webhook k√©r√©s √©rkezett:", JSON.stringify(req.body, null, 2));

  const entry = req.body.entry?.[0];
  const changes = entry?.changes?.[0];
  const value = changes?.value;

  const contactsData = value?.contacts?.[0];
  const wa_id = contactsData?.wa_id || null;
  const name = contactsData?.profile?.name || null;

  if (wa_id) {
    if (name) {
      db.run(
        `INSERT INTO contacts (wa_id, name)
         VALUES (?, ?)
         ON CONFLICT(wa_id) DO UPDATE SET name = excluded.name`,
        [wa_id, name],
        (err) => {
          if (err) console.error("‚ùå DB hiba (contacts - n√©vvel):", err);
        }
      );
    } else {
      db.run(
        `INSERT INTO contacts (wa_id)
         VALUES (?)
         ON CONFLICT(wa_id) DO NOTHING`,
        [wa_id],
        (err) => {
          if (err) console.error("‚ùå DB hiba (contacts - n√©v n√©lk√ºl):", err);
        }
      );
      console.warn(`‚ö†Ô∏è N√©v nem √©rkezett a webhook √ºzenetben (wa_id: ${wa_id})`);
    }
  }

  const messages = value?.messages;
  if (messages) {
    const message = messages[0];
    const messageBody = message.text?.body || '';
    const messageType = message.type;
    const timestamp = new Date().toISOString();
    const wa_message_id = message.id;

    db.get('SELECT id FROM contacts WHERE wa_id = ?', [wa_id], (err, row) => {
      if (err || !row) {
        console.error('‚ùå Nem tal√°lhat√≥ a kontakt az adatb√°zisban:', err);
        return;
      }

      const contact_id = row.id;

      db.run(
        `INSERT INTO messages (contact_id, message_body, message_type, received_at, wa_message_id)
         VALUES (?, ?, ?, ?, ?)`,
        [contact_id, messageBody, messageType, timestamp, wa_message_id],
        function (err) {
          if (err) {
            console.error('‚ùå DB hiba (messages):', err);
          } else {
            console.log('‚úÖ √úzenet mentve, ID:', this.lastID);
          }
        }
      );
    });
  }

  const statuses = value?.statuses;
  if (statuses) {
  statuses.forEach(status => {
    const wa_message_id = status.id;
    const statusValue = status.status;
    const timestamp = new Date(parseInt(status.timestamp) * 1000).toISOString();
    const error = status.errors?.[0];
    const error_code = error?.code || null;
    const error_message = error?.message || null;

    db.get(
      'SELECT id FROM messages WHERE wa_message_id = ?',
      [wa_message_id],
      (err, msgRow) => {
        if (err) {
          console.error(`‚ùå Hiba √ºzenet keres√©sn√©l (metadata ment√©shez):`, err);
          return;
        }

        const localMessageId = msgRow?.id || null;

        if (!localMessageId) {
          console.warn(`‚ö†Ô∏è Nem tal√°lhat√≥ √ºzenet a message_metadata sz√°m√°ra (wa_message_id: ${wa_message_id})`);
          return;
        }

        db.run(
          `INSERT INTO message_metadata (message_id, status, timestamp, error_code, error_message)
           VALUES (?, ?, ?, ?, ?)`,
          [localMessageId, statusValue, timestamp, error_code, error_message],
          function (err) {
            if (err) {
              console.error('‚ùå DB hiba (message_metadata):', err);
            } else {
              console.log(`‚úÖ Status mentve: ${statusValue} (msg_id=${localMessageId})`);
            }
          }
        );
      }
    );
  });
}

  res.sendStatus(200);
});

// JSON v√°lasz: √ñsszes kontakt
app.get('/contacts', (req, res) => {
  const query = `
    SELECT id AS ID, wa_id AS Phone_number, name AS Name
    FROM contacts
    ORDER BY id ASC
  `;

  db.all(query, [], (err, rows) => {
    if (err) {
      console.error('‚ùå Hiba a kontaktok lek√©rdez√©sekor:', err);
      return res.sendStatus(500);
    }
    res.json(rows);
  });
});

// JSON v√°lasz: √ñsszes √ºzenet
app.get('/messages', (req, res) => {
  const query = `
    SELECT 
      messages.id AS ID,
      contacts.wa_id AS Phone_number,
      contacts.name AS Name,
      messages.message_body AS Body,
      messages.message_type AS Type,
      datetime(messages.received_at, 'localtime') AS Received_at
    FROM messages
    JOIN contacts ON messages.contact_id = contacts.id
    ORDER BY messages.received_at DESC
  `;

  db.all(query, [], (err, rows) => {
    if (err) {
      console.error('‚ùå Hiba az √ºzenetek lek√©rdez√©sekor:', err);
      return res.sendStatus(500);
    }
    res.json(rows);
  });
});

// JSON v√°lasz: √úzenet st√°tusz metaadatok
app.get('/message-metadata', (req, res) => {
  const query = `
    SELECT 
      id AS ID,
      message_id AS Message_ID,
      status AS Status,
      timestamp AS Timestamp,
      error_code AS Error_Code,
      error_message AS Error_Message
    FROM message_metadata
    ORDER BY id ASC
  `;

  db.all(query, [], (err, rows) => {
    if (err) {
      console.error('‚ùå Hiba a message_metadata lek√©rdez√©sekor:', err);
      return res.sendStatus(500);
    }
    res.json(rows);
  });
});

// Adatb√°zis f√°jl let√∂lt√©se
app.get('/download-db', (req, res) => {
  fs.access(dbPath, fs.constants.F_OK, (err) => {
    if (err) {
      console.error('‚ùå Az adatb√°zis f√°jl nem tal√°lhat√≥.');
      return res.status(404).send('F√°jl nem tal√°lhat√≥.');
    }

    res.download(dbPath, 'whatsapp_messages.db', (err) => {
      if (err) {
        console.error('‚ùå Hiba a f√°jl let√∂lt√©s√©n√©l:', err);
      } else {
        console.log('‚úÖ Adatb√°zis f√°jl sikeresen let√∂ltve.');
      }
    });
  });
});

app.get('/available-templates', async (req, res) => {
  try {
    const response = await axios.get(
      `https://graph.facebook.com/v19.0/${WHATSAPP_BUSINESS_ACCOUNT_ID}/message_templates`,
      {
        headers: {
          Authorization: `Bearer ${ACCESS_TOKEN}`,
        },
      }
    );

    const templates = {};
    for (const tpl of response.data.data) {
      if (tpl.status === 'APPROVED') {
        const params = [];
        if (tpl.components) {
          for (const c of tpl.components) {
            if (c.type === "BODY" && c.text) {
              const matches = [...c.text.matchAll(/\{\{(\d+)\}\}/g)];
              for (const match of matches) {
                params[parseInt(match[1]) - 1] = `Param√©ter ${match[1]}`;
              }
            }
          }
        }
        templates[tpl.name] = params;
      }
    }

    res.json(templates);
  } catch (error) {
    console.error('‚ùå Hiba a sablonok lek√©rdez√©sekor:', error.response?.data || error.message);
    res.status(500).json({ error: 'Nem siker√ºlt sablonokat lek√©rni.' });
  }
});

// Szerver ind√≠t√°sa
app.listen(port, '0.0.0.0', () => {
  console.log(`üöÄ Szerver fut a http://0.0.0.0:${port} c√≠men`);
});
