require('dotenv').config();
const axios = require('axios');
const express = require('express');
const sqlite3 = require('sqlite3').verbose();
const multer = require('multer');
const path = require('path');
const fs = require('fs');
const FormData = require('form-data');

const app = express();
app.use(express.static(path.join(__dirname, 'public')));
app.use('/sent-media', express.static(path.join(__dirname, 'public/sent_media')));
app.use('/uploads', express.static(path.join(__dirname, 'public/uploads')));
const port = process.env.PORT || 3000;

const dbPath = path.resolve(__dirname, 'whatsapp_messages.db');
console.log('üìÇ Adatb√°zis f√°jl helye:', dbPath);

const db = new sqlite3.Database(dbPath);

db.serialize(() => {
    db.run(`
    CREATE TABLE IF NOT EXISTS contacts (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      wa_id TEXT UNIQUE,
      name TEXT
    )
  `);

    db.run(`
    CREATE TABLE IF NOT EXISTS messages (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      contact_id INTEGER,
      message_body TEXT,
      message_type TEXT,
      received_at DATETIME DEFAULT CURRENT_TIMESTAMP,
      wa_message_id TEXT UNIQUE,
      FOREIGN KEY(contact_id) REFERENCES contacts(id)
    )
  `);

    db.run(`
    CREATE TABLE IF NOT EXISTS sent_messages (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      phone TEXT,
      type TEXT,
      content TEXT,
      timestamp TEXT,
      media_url TEXT,
      wa_message_id TEXT UNIQUE
    )
  `);

    db.run(`
    CREATE TABLE IF NOT EXISTS message_metadata (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      message_id INTEGER,
      status TEXT,
      timestamp TEXT,
      error_code INTEGER,
      error_message TEXT,
      FOREIGN KEY(message_id) REFERENCES messages(id)
    )
  `);

    console.log('‚úÖ Adatb√°zis t√°bl√°k k√©szen √°llnak');
});

app.use(express.json());

// Webhook verifik√°ci√≥
app.get('/webhook', (req, res) => {
    const VERIFY_TOKEN = process.env.VERIFY_TOKEN || 'webhooktoken';
    const mode = req.query['hub.mode'];
    const token = req.query['hub.verify_token'];
    const challenge = req.query['hub.challenge'];

    if (mode && token === VERIFY_TOKEN) {
        console.log('üîê Webhook verifik√°lva!');
        res.status(200).send(challenge);
    } else {
        console.log('‚ùå Webhook verifik√°ci√≥ sikertelen');
        res.sendStatus(403);
    }
});

app.get('/available-templates', async (req, res) => {
    const wabaId = process.env.WHATSAPP_BUSINESS_ACCOUNT_ID;
    const accessToken = process.env.ACCESS_TOKEN;

    console.log('üè¢ Lek√©rdezett WABA_ID:', wabaId);

    if (!wabaId || !accessToken) {
        return res.status(500).json({ error: 'WHATSAPP_BUSINESS_ACCOUNT_ID vagy ACCESS_TOKEN hi√°nyzik.' });
    }

    try {
        const response = await axios.get(
            `https://graph.facebook.com/v19.0/${wabaId}/message_templates`,
            {
                headers: {
                    Authorization: `Bearer ${accessToken}`
                }
            }
        );

        const templates = response.data.data || [];

        const simplified = {};

        templates.forEach(tpl => {
            const templateName = tpl.name;
            const parameters = [];

            tpl.components?.forEach(component => {
                if (component.type === 'BODY' && component.text) {
                    const matches = component.text.match(/\{\{\d+\}\}/g);
                    if (matches) {
                        matches.forEach((_, index) => {
                            parameters.push(`Param√©ter ${index + 1}`);
                        });
                    }
                }
            });

            simplified[templateName] = parameters;
        });

        res.json(simplified);

    } catch (error) {
        console.error('‚ùå Hiba a sablonok lek√©r√©s√©n√©l:', error.response?.data || error.message);
        res.status(500).json({ error: error.response?.data || 'Ismeretlen hiba t√∂rt√©nt.' });
    }
});

app.post('/send-message', async (req, res) => {
    const { phone, message } = req.body;
    const phoneNumberId = process.env.PHONE_NUMBER_ID;
    const accessToken = process.env.ACCESS_TOKEN;

    if (!phone || !message) {
        return res.status(400).json({ message: 'Hi√°nyz√≥ adat (telefonsz√°m vagy √ºzenet)' });
    }

    try {
        const response = await axios.post(
            `https://graph.facebook.com/v19.0/${phoneNumberId}/messages`,
            {
                messaging_product: 'whatsapp',
                to: phone,
                type: 'text',
                text: {
                    preview_url: false,
                    body: message
                },
            },
            {
                headers: {
                    Authorization: `Bearer ${accessToken}`,
                    'Content-Type': 'application/json',
                },
            }
        );

        console.log('‚úÖ √úzenet elk√ºldve:', response.data);

        // üíæ Ment√©s az adatb√°zisba
        if (response.data.messages && response.data.messages[0]?.id) {
            await db.run(
                `INSERT INTO sent_messages (wa_message_id, phone, type, content, timestamp)
         VALUES (?, ?, ?, ?, ?)`,
                [
                    response.data.messages[0].id,
                    phone,
                    'text',
                    message,
                    new Date().toISOString()
                ]
            );
        }

        res.json({ message: '√úzenet sikeresen elk√ºldve ‚úÖ' });
    } catch (error) {
        console.error('‚ùå Hiba az √ºzenetk√ºld√©s sor√°n:', error.response?.data || error.message);
        res.status(500).json({ message: 'Hiba az √ºzenetk√ºld√©s sor√°n' });
    }
});

app.post('/send-template', async (req, res) => {
    const { phone, templateName, languageCode = 'hu', parameters = [] } = req.body;
    const phoneNumberId = process.env.PHONE_NUMBER_ID;
    const accessToken = process.env.ACCESS_TOKEN;

    if (!phone || !templateName) {
        return res.status(400).json({ message: 'Hi√°nyz√≥ telefonsz√°m vagy sablon n√©v' });
    }

    try {
        const response = await axios.post(
            `https://graph.facebook.com/v19.0/${phoneNumberId}/messages`,
            {
                messaging_product: 'whatsapp',
                to: phone,
                type: 'template',
                template: {
                    name: templateName,
                    language: { code: languageCode },
                    components: [
                        {
                            type: 'body',
                            parameters: parameters.map(p => ({
                                type: 'text',
                                text: p
                            }))
                        }
                    ]
                }
            },
            {
                headers: {
                    Authorization: `Bearer ${accessToken}`,
                    'Content-Type': 'application/json',
                }
            }
        );

        console.log('‚úÖ Sablon √ºzenet elk√ºldve:', response.data);

        if (response.data.messages && response.data.messages[0]?.id) {
            await db.run(
                `INSERT INTO sent_messages (wa_message_id, phone, type, content, timestamp, media_url)
         VALUES (?, ?, ?, ?, ?, ?)`,
                [
                    response.data.messages[0].id,
                    phone,
                    'template',
                    templateName,
                    new Date().toISOString(),
                    null
                ]
            );
        }

        res.json({ message: 'Sablon √ºzenet sikeresen elk√ºldve ‚úÖ' });
    } catch (error) {
        console.error('‚ùå Hiba a sablon √ºzenet k√ºld√©sekor:');
        if (error.response) {
            console.error('Status:', error.response.status);
            console.error('Data:', JSON.stringify(error.response.data, null, 2));
        } else {
            console.error('Error:', error.message);
        }
        res.status(500).json({ message: 'Hiba a sablon √ºzenet k√ºld√©sekor' });
    }
});

const upload = multer({ dest: 'uploads/' });

app.post('/send-file-message', upload.single('file'), async (req, res) => {
    const { phone, message } = req.body;
    const phoneNumberId = process.env.PHONE_NUMBER_ID;
    const accessToken = process.env.ACCESS_TOKEN;
    const file = req.file;

    if (!phone || !file) {
        return res.status(400).json({ message: 'Hi√°nyz√≥ telefonsz√°m vagy f√°jl' });
    }

    try {
        // 1. M√©dia felt√∂lt√©se
        const form = new FormData();
        form.append('messaging_product', 'whatsapp');
        form.append('file', fs.createReadStream(file.path), {
            filename: file.originalname || 'upload',
            contentType: file.mimetype || 'application/octet-stream',
        });

        const mediaUpload = await axios.post(
            `https://graph.facebook.com/v19.0/${phoneNumberId}/media`,
            form,
            {
                headers: {
                    Authorization: `Bearer ${accessToken}`,
                    ...form.getHeaders(), // ez automatikusan hozz√°adja a megfelel≈ë multipart content-type-ot
                },
            }
        );


        const mediaId = mediaUpload.data.id;

        // 2. M√©dia √ºzenet k√ºld√©se
        const mediaType = file.mimetype.startsWith('image') ? 'image' : 'document';
        const response = await axios.post(
            `https://graph.facebook.com/v19.0/${phoneNumberId}/messages`,
            {
                messaging_product: 'whatsapp',
                to: phone,
                type: mediaType,
                [mediaType]: {
                    id: mediaId,
                    caption: message || ''
                }
            },
            {
                headers: {
                    Authorization: `Bearer ${accessToken}`,
                    'Content-Type': 'application/json'
                }
            }
        );

        const sentMediaDir = path.join(__dirname, 'public/sent_media');
            fs.mkdirSync(sentMediaDir, { recursive: true });
            
            const localFilename = `${Date.now()}_${file.originalname}`;
            const localPath = path.join(__dirname, 'public/sent_media', localFilename);
            fs.renameSync(file.path, localPath);
            
            const mediaUrl = `/sent-media/${localFilename}`;

        console.log('‚úÖ M√©dia √ºzenet elk√ºldve:', response.data);

        // 3. üíæ Ment√©s a sent_messages t√°bl√°ba
        if (response.data.messages && response.data.messages[0]?.id) {
            await db.run(
                `INSERT INTO sent_messages (wa_message_id, phone, type, content, timestamp, media_url)
         VALUES (?, ?, ?, ?, ?, ?)`,
                [
                    response.data.messages[0].id,
                    phone,
                    mediaType,
                    message || '',
                    new Date().toISOString(),
                    mediaUrl
                ]
            );
        }

        res.json({ message: 'F√°jl sikeresen elk√ºldve ‚úÖ' });
    } catch (error) {
        console.error('‚ùå M√©dia k√ºld√©si hiba:', error.response?.data || error.message);
        res.status(500).json({ message: 'Hiba a f√°jl k√ºld√©sekor' });
    } finally {
        // F√°jl t√∂rl√©se a szerverr≈ël
        if (file && file.path) {
            fs.unlink(file.path, () => {});
        }
    }
});

// Webhook POST - √ºzenet √©s kontakt ment√©se
fs.mkdirSync(path.join(__dirname, 'public/uploads'), { recursive: true });   // Biztos, hogy l√©tezik a mappa

app.post('/webhook', async (req, res) => {
    console.log("üì® Webhook k√©r√©s √©rkezett:", JSON.stringify(req.body, null, 2));

    const entry = req.body.entry?.[0];
    const changes = entry?.changes?.[0];
    const value = changes?.value;

    const contactsData = value?.contacts?.[0];
    const wa_id = contactsData?.wa_id || null;
    const name = contactsData?.profile?.name || null;

    if (wa_id) {
        if (name) {
            db.run(
                `INSERT INTO contacts (wa_id, name)
         VALUES (?, ?)
         ON CONFLICT(wa_id) DO UPDATE SET name = excluded.name`,
                [wa_id, name],
                (err) => {
                    if (err) console.error("‚ùå DB hiba (contacts - n√©vvel):", err);
                }
            );
        } else {
            db.run(
                `INSERT INTO contacts (wa_id)
         VALUES (?)
         ON CONFLICT(wa_id) DO NOTHING`,
                [wa_id],
                (err) => {
                    if (err) console.error("‚ùå DB hiba (contacts - n√©v n√©lk√ºl):", err);
                }
            );
            console.warn(`‚ö†Ô∏è N√©v nem √©rkezett a webhook √ºzenetben (wa_id: ${wa_id})`);
        }
    }

    const messages = value?.messages;
    if (messages) {
        const message = messages[0];
        const messageType = message.type;
        const wa_message_id = message.id;
        const timestamp = new Date().toISOString();

        let messageBody = '';

        // --- üéØ KEZEL√âS: K√©p vagy dokumentum ---
        if (messageType === 'image' || messageType === 'document') {
            const mediaId = message[messageType]?.id;
            const accessToken = process.env.ACCESS_TOKEN;

            try {
                const mediaInfo = await axios.get(`https://graph.facebook.com/v19.0/${mediaId}`, {
                    headers: { Authorization: `Bearer ${accessToken}` }
                });

                const mediaUrl = mediaInfo.data.url;
                const mediaResponse = await axios.get(mediaUrl, {
                    responseType: 'stream',
                    headers: { Authorization: `Bearer ${accessToken}` }
                });

                const ext = messageType === 'image' ? '.jpg' : path.extname(message.document?.filename || '.bin');
                const fileName = `${messageType}_${Date.now()}${ext}`;
                const filePath = path.join(__dirname, 'public/uploads', fileName);
                const fileUrl = `/uploads/${fileName}`;
                const writer = fs.createWriteStream(filePath);
                mediaResponse.data.pipe(writer);

                messageBody = fileUrl;

                console.log(`üìÅ ${messageType} f√°jl mentve: ${fileUrl}`);
            } catch (err) {
                console.error(`‚ùå Hiba a(z) ${messageType} let√∂lt√©s√©n√©l:`, err.response?.data || err.message);
                messageBody = '(media let√∂lt√©si hiba)';
            }
        }

        // --- üìù Sz√∂veges √ºzenet ---
        if (messageType === 'text') {
            messageBody = message.text?.body || '';
        }

        // --- üîΩ Ment√©s adatb√°zisba ---
        db.get('SELECT id FROM contacts WHERE wa_id = ?', [wa_id], (err, row) => {
            if (err || !row) {
                console.error('‚ùå Nem tal√°lhat√≥ a kontakt az adatb√°zisban:', err);
                return;
            }

            const contact_id = row.id;

            db.run(
                `INSERT INTO messages (contact_id, message_body, message_type, received_at, wa_message_id)
         VALUES (?, ?, ?, ?, ?)`,
                [contact_id, messageBody, messageType, timestamp, wa_message_id],
                function (err) {
                    if (err) {
                        console.error('‚ùå DB hiba (messages):', err);
                    } else {
                        console.log('‚úÖ √úzenet mentve, ID:', this.lastID);
                    }
                }
            );
        });
    }

    // --- üîÅ St√°tuszok ment√©se ---
    const statuses = value?.statuses;
    if (statuses) {
        statuses.forEach(status => {
            const wa_message_id = status.id;
            const statusValue = status.status;
            const timestamp = new Date(parseInt(status.timestamp) * 1000).toISOString();
            const error = status.errors?.[0];
            const error_code = error?.code || null;
            const error_message = error?.message || null;

            db.get(
                'SELECT id FROM messages WHERE wa_message_id = ?',
                [wa_message_id],
                (err, msgRow) => {
                    if (err) {
                        console.error(`‚ùå Hiba √ºzenet keres√©sn√©l (metadata ment√©shez):`, err);
                        return;
                    }

                    const localMessageId = msgRow?.id || null;
                    if (!localMessageId) {
                        console.warn(`‚ö†Ô∏è Nem tal√°lhat√≥ √ºzenet a message_metadata sz√°m√°ra (wa_message_id: ${wa_message_id})`);
                        return;
                    }

                    db.run(
                        `INSERT INTO message_metadata (message_id, status, timestamp, error_code, error_message)
             VALUES (?, ?, ?, ?, ?)`,
                        [localMessageId, statusValue, timestamp, error_code, error_message],
                        function (err) {
                            if (err) {
                                console.error('‚ùå DB hiba (message_metadata):', err);
                            } else {
                                console.log(`‚úÖ Status mentve: ${statusValue} (msg_id=${localMessageId})`);
                            }
                        }
                    );
                }
            );
        });
    }

    res.sendStatus(200);
});

// JSON v√°lasz: √ñsszes kontakt
app.get('/contacts', (req, res) => {
    const query = `
    SELECT id AS ID, wa_id AS Phone_number, name AS Name
    FROM contacts
    ORDER BY id ASC
  `;

    db.all(query, [], (err, rows) => {
        if (err) {
            console.error('‚ùå Hiba a kontaktok lek√©rdez√©sekor:', err);
            return res.sendStatus(500);
        }
        res.json(rows);
    });
});

// JSON v√°lasz: √ñsszes √ºzenet
app.get('/messages', (req, res) => {
    const query = `
    SELECT 
      messages.id AS ID,
      contacts.wa_id AS Phone_number,
      contacts.name AS Name,
      messages.message_body AS Body,
      messages.message_type AS Type,
      datetime(messages.received_at, 'localtime') AS Received_at
    FROM messages
    JOIN contacts ON messages.contact_id = contacts.id
    ORDER BY messages.received_at DESC
  `;

    db.all(query, [], (err, rows) => {
        if (err) {
            console.error('‚ùå Hiba az √ºzenetek lek√©rdez√©sekor:', err);
            return res.sendStatus(500);
        }
        res.json(rows);
    });
});

// JSON v√°lasz: √úzenet st√°tusz metaadatok
app.get('/message-metadata', (req, res) => {
    const query = `
    SELECT 
      id AS ID,
      message_id AS Message_ID,
      status AS Status,
      timestamp AS Timestamp,
      error_code AS Error_Code,
      error_message AS Error_Message
    FROM message_metadata
    ORDER BY id ASC
  `;

    db.all(query, [], (err, rows) => {
        if (err) {
            console.error('‚ùå Hiba a message_metadata lek√©rdez√©sekor:', err);
            return res.sendStatus(500);
        }
        res.json(rows);
    });
});

app.get('/sent-messages', (req, res) => {
    db.all(`SELECT * FROM sent_messages ORDER BY timestamp DESC`, [], (err, rows) => {
        if (err) {
            console.error('‚ùå Hiba az √ºzenetek lek√©rdez√©s√©n√©l:', err.message);
            return res.status(500).json({ message: 'Adatb√°zis hiba' });
        }
        res.json(rows);
    });
});

// Adatb√°zis f√°jl let√∂lt√©se
app.get('/download-db', (req, res) => {
    fs.access(dbPath, fs.constants.F_OK, (err) => {
        if (err) {
            console.error('‚ùå Az adatb√°zis f√°jl nem tal√°lhat√≥.');
            return res.status(404).send('F√°jl nem tal√°lhat√≥.');
        }

        res.download(dbPath, 'whatsapp_messages.db', (err) => {
            if (err) {
                console.error('‚ùå Hiba a f√°jl let√∂lt√©s√©n√©l:', err);
            } else {
                console.log('‚úÖ Adatb√°zis f√°jl sikeresen let√∂ltve.');
            }
        });
    });
});

// Szerver ind√≠t√°sa
app.listen(port, '0.0.0.0', () => {
    console.log(`üöÄ Szerver fut a http://0.0.0.0:${port} c√≠men`);
});
