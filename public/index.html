<!DOCTYPE html>
<html lang="hu">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>WhatsApp √úzenetk√ºld≈ë</title>
<style>
  /* --- Design CSS az els≈ë k√≥db√≥l --- */
  :root {
    --accent: #26a69a;
    --text: #111;
    --bg-light-start: #ffffff;
    --bg-light-end: #e0f7f5;
    --bg-dark-start: #2c2c2c;
    --bg-dark-end: #1a4034;
  }

  [data-theme="light"] {
    --bg-start: var(--bg-light-start);
    --bg-end: var(--bg-light-end);
    --text: #111;
    --border: #ccc;
    --input-bg: #f0f0f0;
  }
  [data-theme="dark"] {
    --bg-start: var(--bg-dark-start);
    --bg-end: var(--bg-dark-end);
    --text: #eee;
    --border: #444;
    --input-bg: #2c2c2c;
  }

  body {
    background: var(--bg-start);
    color: var(--text);
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    margin: 2rem;
    transition: background 0.3s ease, color 0.3s ease;
  }

  .container {
    background: linear-gradient(135deg, var(--bg-start) 0%, var(--bg-end) 100%);
    border-radius: 1.25rem;
    box-shadow: 0 12px 30px rgba(38, 166, 154, 0.25);
    padding: 2.5rem;
    max-width: 600px;
    margin: 0 auto;
    transition: background 0.3s ease, box-shadow 0.3s ease;
  }

  [data-theme="dark"] .container {
    box-shadow: 0 12px 30px rgba(38, 166, 154, 0.8);
  }

  h1 {
    color: var(--accent);
    text-align: center;
    margin-bottom: 1rem;
  }

  label {
    display: block;
    margin-top: 1rem;
    font-weight: 600;
  }

  input[type="text"], input[type="file"], select, textarea {
    width: 100%;
    padding: 0.75rem;
    margin-top: 0.3rem;
    border-radius: 0.5rem;
    border: 1px solid var(--border);
    background-color: var(--input-bg);
    color: var(--text);
    font-size: 1rem;
    box-sizing: border-box;
    transition: background-color 0.3s ease, color 0.3s ease;
  }

  textarea {
    resize: vertical;
  }

  button {
    width: 100%;
    margin-top: 1.5rem;
    padding: 0.75rem;
    border-radius: 1.5rem;
    border: none;
    background-color: var(--accent);
    color: white;
    font-weight: 700;
    font-size: 1rem;
    cursor: pointer;
    transition: background-color 0.3s ease;
  }

  button:hover:not(:disabled) {
    background-color: #00796b;
  }

  button:disabled {
    background-color: #a2d2cd;
    cursor: not-allowed;
  }

  #status {
    margin-top: 1rem;
    font-weight: 600;
    text-align: center;
    opacity: 0;
    transition: opacity 0.4s ease;
  }
  #status.show {
    opacity: 1;
  }

  .history {
    margin-top: 2rem;
  }

  .history h2 {
    margin-bottom: 0.5rem;
  }

  .history ul {
    list-style: none;
    padding-left: 0;
    max-height: 150px;
    overflow-y: auto;
  }

  .history li {
    padding: 0.5rem 0;
    border-bottom: 1px solid var(--border);
    font-size: 0.9rem;
  }

  .theme-toggle {
    text-align: right;
    margin-bottom: 1rem;
  }

  .theme-toggle button {
    background: none;
    border: 2px solid var(--accent);
    border-radius: 1.5rem;
    padding: 0.3rem 1rem;
    font-weight: 700;
    font-size: 1rem;
    color: var(--accent);
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    transition: background-color 0.3s ease, color 0.3s ease;
  }

  .theme-toggle button:hover {
    background-color: var(--accent);
    color: white;
  }

  #filePreview {
    margin-top: 0.75rem;
    font-size: 0.9rem;
    color: var(--text);
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }

  #filePreview img {
    max-height: 60px;
    max-width: 60px;
    object-fit: contain;
    border-radius: 0.5rem;
    border: 1px solid var(--border);
  }

  .template-param {
    margin-top: 0.3rem;
  }
</style>
</head>
<body>
  <div class="container" id="app" data-theme="light">
    <div class="theme-toggle">
      <button id="themeToggleBtn">üåô S√∂t√©t m√≥d</button>
    </div>

    <h1>üì® WhatsApp √úzenetk√ºld≈ë</h1>

    <label for="name">N√©v (opcion√°lis):</label>
    <input type="text" id="name" placeholder="Pl. G√°bor" />

    <label for="phone">Telefonsz√°m (+36...):</label>
    <input type="text" id="phone" placeholder="+36123456789" />

    <label for="templateType">Sablon t√≠pusa:</label>
    <select id="templateType">
      <option value="text">Egyszer≈± sz√∂veges sablon</option>
      <option value="whatsapp">WhatsApp API sablon</option>
    </select>

    <label for="template">√úzenet sablon:</label>
    <select id="template">
      <option value="">-- V√°lassz sablont --</option>
    </select>

    <div id="templateParams"></div>

    <label for="message">Egyedi √ºzenet:</label>
    <textarea id="message" rows="4" placeholder="√çrd be az √ºzenetet..."></textarea>

    <label for="file">F√°jl vagy k√©p csatol√°sa:</label>
    <input type="file" id="file" accept="image/*,application/pdf" />
    <div id="filePreview"></div>

    <button id="sendBtn">√úzenet k√ºld√©se</button>

    <div id="status"></div>

    <div class="history">
      <h2>üìú El≈ëzm√©nyek</h2>
      <ul id="historyList"></ul>
    </div>
  </div>

  <script>
    // √Ålland√≥ sablonok
    const textTemplates = {
      "Szia! Hogy vagy?": "Szia! Hogy vagy?",
      "K√©rlek, h√≠vj vissza!": "K√©rlek, h√≠vj vissza!",
      "K√ºld√∂m, amit megbesz√©lt√ºnk.": "K√ºld√∂m, amit megbesz√©lt√ºnk."
    };

    let whatsappTemplates = {}; // majd dinamikusan t√∂ltj√ºk

    // DOM elemek
    const templateTypeSelect = document.getElementById('templateType');
    const templateSelect = document.getElementById('template');
    const messageBox = document.getElementById('message');
    const templateParamsDiv = document.getElementById('templateParams');
    const sendBtn = document.getElementById('sendBtn');
    const statusDiv = document.getElementById('status');
    const historyList = document.getElementById('historyList');
    const fileInput = document.getElementById('file');
    const filePreview = document.getElementById('filePreview');
    const themeToggleBtn = document.getElementById('themeToggleBtn');
    const container = document.querySelector('.container');
    const body = document.body;

    // T√©ma v√°lt√°s funkci√≥
    function updateThemeToggleButton() {
      const current = body.getAttribute('data-theme') || 'light';
      if (current === 'dark') {
        themeToggleBtn.textContent = 'üåû Vil√°gos m√≥d';
      } else {
        themeToggleBtn.textContent = 'üåô S√∂t√©t m√≥d';
      }
    }

    function toggleTheme() {
      const current = body.getAttribute('data-theme');
      const next = current === 'dark' ? 'light' : 'dark';
      body.setAttribute('data-theme', next);
      container.setAttribute('data-theme', next);
      updateThemeToggleButton();
    }

    themeToggleBtn.addEventListener('click', toggleTheme);
    updateThemeToggleButton();

    // Sablonok felt√∂lt√©se
    function loadTemplates() {
      // Els≈ëk√©nt sz√∂veges sablonok
      if(templateTypeSelect.value === 'text') {
        templateSelect.innerHTML = '<option value="">-- V√°lassz sablont --</option>';
        for (const key in textTemplates) {
          const opt = document.createElement('option');
          opt.value = key;
          opt.textContent = key;
          templateSelect.appendChild(opt);
        }
        templateParamsDiv.innerHTML = '';
        messageBox.value = '';
      } else if (templateTypeSelect.value === 'whatsapp') {
        // API h√≠v√°s sablonok√©rt
        fetch('/get-template-list')
          .then(res => res.json())
          .then(data => {
            whatsappTemplates = data.templates || {};
            templateSelect.innerHTML = '<option value="">-- V√°lassz sablont --</option>';
            for (const key in whatsappTemplates) {
              const opt = document.createElement('option');
              opt.value = key;
              opt.textContent = key;
              templateSelect.appendChild(opt);
            }
            templateParamsDiv.innerHTML = '';
            messageBox.value = '';
          }).catch(err => {
            console.error(err);
            templateSelect.innerHTML = '<option value="">Nem siker√ºlt bet√∂lteni</option>';
          });
      }
    }

    templateTypeSelect.addEventListener('change', loadTemplates);
    loadTemplates();

    // Sablon v√°laszt√°skor param√©terek megjelen√≠t√©se
    templateSelect.addEventListener('change', () => {
      const val = templateSelect.value;
      if(templateTypeSelect.value === 'text') {
        messageBox.value = textTemplates[val] || '';
        templateParamsDiv.innerHTML = '';
      } else if(templateTypeSelect.value === 'whatsapp' && val) {
        const template = whatsappTemplates[val];
        if(!template) {
          templateParamsDiv.innerHTML = '';
          messageBox.value = '';
          return;
        }
        // Felt√©telezz√ºk, hogy a template param√©terei egy t√∂mb, pl:
        // template.parameters = [{name:"firstName"}, {name:"date"}]
        templateParamsDiv.innerHTML = '';
        if(template.parameters && template.parameters.length > 0) {
          template.parameters.forEach(param => {
            const label = document.createElement('label');
            label.textContent = `Param√©ter: ${param.name}`;
            label.className = 'template-param';
            const input = document.createElement('input');
            input.type = 'text';
            input.dataset.paramName = param.name;
            input.placeholder = `√çrd be a(z) ${param.name} √©rt√©k√©t`;
            templateParamsDiv.appendChild(label);
            templateParamsDiv.appendChild(input);
          });
        }
        messageBox.value = '';
      }
    });

    // F√°jl el≈ën√©zet megjelen√≠t√©s
    fileInput.addEventListener('change', () => {
      const file = fileInput.files[0];
      filePreview.innerHTML = '';
      if(!file) return;

      if(file.type.startsWith('image/')) {
        const img = document.createElement('img');
        img.src = URL.createObjectURL(file);
        filePreview.appendChild(img);
      } else {
        filePreview.textContent = `Csatolt f√°jl: ${file.name} (${(file.size/1024).toFixed(1)} KB)`;
      }
    });

    // √úzenetk√ºld√©s
      sendBtn.addEventListener('click', () => {
        const phone = document.getElementById('phone').value.trim();
        const name = document.getElementById('name').value.trim();
        const message = messageBox.value.trim();
        const templateType = templateTypeSelect.value;
        const templateName = templateSelect.value;
      
        if(!phone.match(/^\+36\d{8,9}$/)) {
          alert('K√©rlek, adj meg egy √©rv√©nyes magyar telefonsz√°mot +36 form√°tumban!');
          return;
        }
        if(templateType === 'text' && !message) {
          alert('Az √ºzenet nem lehet √ºres!');
          return;
        }
      
        sendBtn.disabled = true;
        statusDiv.textContent = '√úzenet k√ºld√©se folyamatban...';
        statusDiv.classList.add('show');
      
        const formData = new FormData();
        formData.append('phone', phone);
        formData.append('name', name);
        formData.append('message', message);
        formData.append('templateType', templateType);
        formData.append('templateName', templateName);
      
        if(templateType === 'whatsapp' && templateName) {
          const paramsInputs = templateParamsDiv.querySelectorAll('input[data-param-name]');
          const params = {};
          paramsInputs.forEach(input => {
            params[input.dataset.paramName] = input.value.trim();
          });
          formData.append('parameters', JSON.stringify(params));
        }
      
        const file = fileInput.files[0];
        if(file) {
          formData.append('file', file);
        }
      
        // V√âGPONT kiv√°laszt√°s:
        let url;
        if(file) {
          url = '/send-file-message';
        } else if(templateType === 'whatsapp' && templateName) {
          url = '/send-template-message';
        } else {
          url = '/send-message';
        }
      
        fetch(url, {
          method: 'POST',
          body: formData
        })
        .then(res => res.json())
        .then(data => {
          // Ellen≈ërizz√ºk a visszat√©r≈ë adatot:
          if(data && data.success) {
            statusDiv.textContent = '‚úÖ √úzenet sikeresen elk√ºldve!';
            addHistory(phone, message);
            clearForm();
          } else {
            statusDiv.textContent = '‚ùå Hiba t√∂rt√©nt: ' + (data.error || 'Ismeretlen hiba');
          }
        })
        .catch(err => {
          statusDiv.textContent = '‚ùå H√°l√≥zati hiba t√∂rt√©nt.';
          console.error(err);
        })
        .finally(() => {
          sendBtn.disabled = false;
          setTimeout(() => {
            statusDiv.classList.remove('show');
            statusDiv.textContent = '';
          }, 4000);
        });
      });

      // F√°jl felt√∂lt√©s
      const file = fileInput.files[0];
      if(file) {
        formData.append('file', file);
      }

      // API h√≠v√°s
      let url;
      if(file) {
        url = '/send-file-message';
      } else if(templateType === 'whatsapp') {
        url = '/send-template-message';
      } else {
        url = '/send-message';
      }

      fetch(url, {
        method: 'POST',
        body: formData
      })
      .then(res => res.json())
      .then(data => {
        if(data.success) {
          statusDiv.textContent = '√úzenet sikeresen elk√ºldve!';
          addHistory(phone, message);
          clearForm();
        } else {
          statusDiv.textContent = 'Hiba t√∂rt√©nt: ' + (data.error || 'Ismeretlen hiba');
        }
      })
      .catch(err => {
        statusDiv.textContent = 'H√°l√≥zati hiba t√∂rt√©nt.';
        console.error(err);
      })
      .finally(() => {
        sendBtn.disabled = false;
        setTimeout(() => {
          statusDiv.classList.remove('show');
          statusDiv.textContent = '';
        }, 4000);
      });
    });

    // El≈ëzm√©nyek hozz√°ad√°sa
    function addHistory(phone, message) {
      const li = document.createElement('li');
      li.textContent = `${phone}: ${message}`;
      historyList.prepend(li);
    }

    // ≈∞rlap t√∂rl√©se
    function clearForm() {
      document.getElementById('message').value = '';
      document.getElementById('file').value = '';
      document.getElementById('template').value = '';
      document.getElementById('templateParams').innerHTML = '';
      document.getElementById('name').value = '';
    }
  </script>
</body>
</html>
